---
Title: Настройка провайдера Microsoft OAuth
weight: 20
---

:author: likhobory
:email: likhobory@mail.ru

:toc:
:toc-title: Оглавление

:experimental:

:imagesdir: /images/ru/admin/Email/microsoft

ifdef::env-github[:imagesdir: ./../../../../master/static/images/ru/admin/Email/microsoft]

:btn: btn:

ifdef::env-github[:btn:]

:en-img: ../../../../../images/en/admin/email/microsoft/

ifdef::env-github[:en-img: ./../../../../../images/en/admin/email/microsoft/]

//
:sectnums:
:sectnumlevels: 2
//

== Введение

В этом разделе описывается настройка клиента в Microsoft Azure, с последующим использованием полученной информации для настройки провайдера OAuth в SuiteCRM.


== Регистрация приложения SuiteCRM в Microsoft Azure

{{% notice note %}}
Предполагается, что вы настраиваете провайдера для учётной записи компании, которая будет использоваться пользователями приложения.
{{% /notice %}}

=== Регистрация приложения

Перейдите по ссылке https://portal.azure.com[https://portal.azure.com^] и войдите в портал.

Главная страница портала может выглядеть следующим образом:

image:image001.png[azure-Главная страница]

Проверьте, что ссылка *Регистрация приложений* отображается на главной странице.

image:image002.png[azure-службы]

В противном случае перейдите по ссылке *Больше служб* и в открывшемся перечне найдите ссылку.

image:image003.png[azure-больше-служб]

image:image004.png[azure-ссылка-Регистрация приложений]

Страница *Регистрация приложений* может выглядеть следующим образом:

image:image005.png[azure-Регистрация приложений]

=== Регистрация нового приложения

На странице *Регистрация приложений* перейдите по ссылке *Новая регистрация* 

image:image006.png[azure-Регистрация нового приложения]

На странице регистрации выполните следующее:

. Укажите имя приложения, например - *SuiteCRM*
. Выберите один из типов поддерживаемых учётных записей 

{{% notice note %}}
В этом примере выбран произвольный тип учётной записи.
Вам необходимо выбрать тип, который подходит для вашего варианта использования.
{{% /notice %}}

[start=3]
. Укажите URI перенаправления, что-то вроде: `\https://<your-suitecrm-instance-host>/index.php?entryPoint=setExternalOAuthToken`


{{% notice note %}}
Azure поддерживает только защищённые (https) соединения, за исключение тех случаев, когда в качестве хоста указывается *localhost*.
{{% /notice %}}

Пример неправильного URI:

* _\http://my-suitecrm.com/index.php?entryPoint=setExternalOAuthToken_

Пример правильного URI:

* _\https://my-suitecrm.com/index.php?entryPoint=setExternalOAuthToken_
* _\http://localhost/index.php?entryPoint=setExternalOAuthToken_

image:image007.png[azure-Ввод данных регистрации]

После ввода необходимой информации нажмите на кнопку {btn}[Зарегистрировать], после чего откроется страница с детальной информацией о зарегистрированном приложении.

image:image008.png[azure-main-app-registration-page.png]

Здесь же отображается и идентификатор приложения (клиент), который позже понадобится в качестве ID клиента при настройке SuiteCRM.

image:image009.png[azure-client-id.png]

=== Создание секрета клиента

На следующем шаге необходимо создать секрет клиента, который будет использоваться для связи SuiteCRM с Microsoft.

Нажмите на ссылку *Добавить сертификат или секрет*.

image:image010.png[azure-добавить секрет.png]

Откроется страница *Сертификаты и секреты*.

image:image011.png[azure-cerfiticates-and-secrets-page.png]

Для создания секрета нажмите на ссылку *Новый секрет клиента*.

image:image012.png[azure-new-client-secret.png]

На появившейся панели укажите описание секрета и его срок действия, после чего нажмите на кнопку {btn}[Добавить].

image:image013.png[azure-add-a-client-secret-sidebar.png]

На странице *Сертификаты и секреты* появится соответствующая строка:

image:image014.png[azure-new-client-secret.png]

Скопируйте секрет, нажав на иконку справа от значения, и сохраните его в надёжном месте. +
*Более это значение не будет доступно через интерфейс  Microsoft Azure!*


image:image015.png[azure-secret-value.png]

Вернитесь на страницу регистрации приложения, нажав на боковой панели ссылку *Обзор*.

image:image016.png[azure-link-to-app-registration-overview.png]

=== Определение разрешённых областей

На следующем шаге необходимо определить области, к которым SuiteCRM будет иметь доступ.

На странице регистрации приложения нажмите на кнопку  {btn}[Просмотреть разрешения API].

image:image017.png[azure-view-api-permissions-link.png]

[[Scopes]]
Откроется страница *Разрешения API*

image:image018.png[azure-view-api-permissions-link.png]

Теперь добавьте области, к которым будет разрешён доступ. Нажмите на ссылку *Добавить разрешение*.

image:image019.png[azure-add-permission-link.png]

Появится панель запроса разрешений API.

image:image020.png[azure-add-permission-sidebar-clean.png]

Необходимо настроить разрешения в интерфейсе *Microsoft Graph*, который мы и выбираем.

image:image021.png[azure-microsoft-graph-permissions-link.png]

Теперь следует выбрать, какой тип разрешений требуется вашему приложению.

image:image022.png[azure-microsoft-graph-permission-types.png]

Выберите *Делегированные разрешения*.

image:image023.png[azure-delegated-permissions-link.png]

После чего отобразится список доступных разрешений.

В строке поиска введите `offline_access`, после чего отфильтруется соответствующее разрешение. Выберите его и нажмите на кнопку {btn}[Добавить разрешения].

image:image024.png[azure-add-offline-access-permission.png]

Повторите те же действия для разрешений:

 * `IMAP.AccessAsUser.All`
 * `User.Read`

image:image025.png[azure-add-imap-permission.png]
image:image026.png[azure-add-user-read-permission.png]

После добавления указанных разрешений таблица разрешений скорее всего будет выглядеть следующим образом:

image:image027.png[azure-api-permissions-page-with-values.png]

Вернитесь на страницу регистрации приложения, нажав на боковой панели ссылку *Обзор*.

image:image016.png[azure-link-to-app-registration-overview.png]

=== Добавление URI перенаправления

На следующем шаге необходимо настроить проверку подлинности, указав URI перенаправления и другие соответствующие параметры.

Вернитесь на страницу регистрации приложения.

image:image028.png[azure-main-app-registration-page.png]

Нажмите на ссылку *Добавить URI перенаправления*.

image:image029.png[azure-redirect-uri-link.png]

Откроется страница *Проверка подлинности*, где уже будет указан настроенный ранее URI перенаправления.

image:image030.png[azure-redirect-uri-list.png]


В разделе *Неявное предоставление разрешения и гибридные потоки* выберите *Токены доступа (используются для неявных потоков)* и нажмите на кнопку {btn}[Сохранить].

image:image031.png[azure-enable-access-token.png]

Вернитесь на страницу регистрации приложения, нажав на боковой панели ссылку *Обзор*.

image:image016.png[azure-link-to-app-registration-overview.png]

=== Получение информации о конечных точках

На последнем шаге необходимо скопировать информацию о следующих конечных точках:

 * OAuth 2.0 authorization endpoint
 * OAuth 2.0 authorization endpoint (v2)

В верхней части страницы регистрации приложения..

image:{en-img}azure-main-app-registration-page.png[azure-main-app-registration-page.png]


нажмите на ссылку *Конечные точки*.

image:{en-img}azure-endpoints-link.png[azure-endpoints-link.png]

После чего отобразится боковая панель.

image:{en-img}azure-endpoints-sidebar.png[azure-endpoints-sidebar.png]

Скопируйте и сохраните указанные ниже конечные точки. В дальнейшем они будут использованы в настройках SuiteCRM.

image:{en-img}azure-required-endpoints.png[azure-required-endpoints.png]



== Настройка провайдера Microsoft в SuiteCRM

Ниже описаны настройки группового провайдера, который может быть использован  несколькими пользователями SuiteCRM.
Описанный сценарий будет полезен только в том случае, если приложение зарегистрировано в Azure для учётных записей, находящихся в одном домене, обычно это учетные записи, которые не являются учётными записями @outlook и им подобными.

{{% notice note %}}
Настройка группового провайдера OAuth может производиться только администратором системы.
{{% /notice %}}

Войдите в SuiteCRM под учётной записью администратора и откройте  панель администрирования.

Откройте настройку *Внешние провайдеры OAuth*.

image:image036.png[suitecrm-external-oauth-provider-module.png]

В качестве администраторы системы вам доступно создание двух видов  записей:

 * Персональные провайдеры OAuth
 ** Доступны только создавшим их пользователям
 ** Предназначены для настройки доступа к личным учётным записям у различных провайдеров, без личного домена. Например, для настройки доступа к вашим учетным записям *_@gmail_* или *_@outlook_*. Они могут иметь общие настройки группы, поскольку значения полей *ID клиента*, *Секрет клиента* и других  будут уникальными для каждой учётной записи.
 * Групповые провайдеры OAuth
 ** Могут быть использованы несколькими пользователями
 ** Предназначены для использования всеми пользователями, имеющими учётные записи в одном и том же домене, например -  *_@example-inc.onmicrosoft.com_*. Значения полей *ID клиента*, *Секрет клиента* и других  будут  одинаковыми для всех учётных записей, использующих этот домен.

Как уже упоминалось ранее, мы собираемся настроить провайдера, который будет использоваться несколькими пользователями, поэтому в следующем примере будет создана групповая запись.

 . В меню модуля выберите пункт *Создать группового провайдера OAuth* и заполните следующие поля:

image:image037.png[suitecrm-connector-selection.png]

Название:: Добавьте значимое имя для создаваемого провайдера, это может быть просто *Microsoft*, имя вашего домена или что-то, что поможет вам идентифицировать и отличить запись от других провайдеров.
Подключение:: Выберите *Microsoft*. Подключение *Microsoft* работает так же, как и подключение *Generic*. Разница в том, что в первом случае используются несколько встроенных значений по умолчанию. Это избавляет вас от лишних шагов настройки и упрощает процесс подключения внешнего провайдера OAuth.
Область:: Добавьте *Области*, к которым вы хотите получить доступ: эти значения вы уже настроили ранее на странице <<Scopes,разрешений API>>.

 * `offline_access`
 * `\https://outlook.office.com/IMAP.AccessAsUser.All`
 * `User.Read`

ID клиента:: Добавьте идентификатор клиента, созданный ранее в Azure.
Секрет клиента:: Добавьте созданный ранее в Azure секрет клиента.
URI сервера авторизации:: Добавьте значение, скопированное ранее из конечных точек Azure (OAuth 2.0 authorization endpoint (v2)).
URI токена доступа:: Добавьте значение, скопированное ранее из конечных точек Azure (OAuth 2.0 token endpoint (v2)).

Поскольку другие поля уже содержат значения по умолчанию, их настройка не требуется.

{{% notice note %}}
Настройка оставшихся полей рассматривается в разделах 
link:../oauth-provider-overview/#_дополнительные_настройки[Дополнительные настройки] и 
link:../oauth-provider-overview/#_настройки_сопоставления[Настройки сопоставления].
{{% /notice %}}

[start=2] 
 . Нажмите на кнопку {btn}[Сохранить].


== Настройка входящей почты пользователя

Теперь пользователи должны иметь возможность использовать созданного вами поставщика OAuth для аутентификации в Microsoft.

Перейдите к разделу 
link:../inboundemail-oauth-howto[Настройка входящих E-mail с использованием OAuth], чтобы узнать, какие шаги необходимо предпринять пользователям для настройки входящей электронной почты с использованием OAuth.



